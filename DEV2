-- Eternal Detector & Auto-Focus/Auto-Teleport
-- Modifikasi: Perbaikan error yang menyebabkan UI tidak muncul
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Variabel global
autoFocus = true
autoTeleport = true
autoStart = true
autoFly = true

-- Variabel untuk filter kelangkaan
local rarityFilter = {
    common = true, uncommon = true, rare = true,
    epic = true, legendary = true, mythical = true,
}

-- Fungsi bantuan
local function getRoot()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    return character:WaitForChild("HumanoidRootPart")
end

local function getCharacter()
    return localPlayer.Character or localPlayer.CharacterAdded:Wait()
end

-- Titik teleportasi
local spots = {
    {name="Spot 1", pos=Vector3.new(-26.609,115.715,-285.779)},
    {name="Spot 2", pos=Vector3.new(-26.456,113.007,-154.013)},
    {name="Spot 3", pos=Vector3.new(-24.498,116.377,-2.832)},
}

-- Nama-nama ikan Eternal
local ETERNAL_NAMES = {
    SFish1 = "Loch Ness", SFish2 = "Skeleton",
    SFish3 = "Sea Elf", SFish4 = "Godzilla",
}

-- UI references
local screenGui, info, distLabel, anchorLabel
local sidebarFrame, sidebarHeader, tabContainer, farmTab, generalTab
local farmContent, generalContent

-- Fungsi Debug "Instant Farm All"
local function instantFarmAll(button)
    pcall(function()
        button.Text = "MEMPROSES..."
        button.BackgroundColor3 = Color3.fromRGB(255, 165, 0) -- Oranye

        local fishList = workspace:FindFirstChild("FishModelList")
        if not fishList then return end

        local allFishModels = {}
        for _, m in ipairs(fishList:GetChildren()) do
            if m:IsA("Model") then
                local hum = m:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health > 0 then
                    table.insert(allFishModels, m)
                    hum.Health = 1
                end
            end
        end

        task.wait(0.1)

        local screenSize = workspace.CurrentCamera.ViewportSize
        local centerX = screenSize.X / 2
        local centerY = screenSize.Y / 2
        local originalCFrame = camera.CFrame

        for _, fishModel in ipairs(allFishModels) do
            if fishModel and fishModel.PrimaryPart and fishModel.PrimaryPart:IsDescendantOf(workspace) then
                local targetPos = fishModel.PrimaryPart.Position
                camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetPos)
                task.wait()
                VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
                VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)
                task.wait(0.05)
            end
        end

        camera.CFrame = originalCFrame
        button.Text = "Instant Farm All (DEV)"
        button.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
    end)
end

-- Fungsi untuk membangun UI
local function buildUI()
    local pg = localPlayer:FindFirstChild("PlayerGui") or localPlayer:WaitForChild("PlayerGui")
    if screenGui then pcall(function() screenGui:Destroy() end) end

    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FishFarmUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = pg

    sidebarFrame = Instance.new("Frame")
    sidebarFrame.Size = UDim2.new(0, 280, 0, 580)
    sidebarFrame.Position = UDim2.new(0, 10, 0, 120)
    sidebarFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
    sidebarFrame.Parent = screenGui
    
    sidebarHeader = Instance.new("Frame")
    sidebarHeader.Size = UDim2.new(1, 0, 0, 30)
    sidebarHeader.BackgroundColor3 = Color3.fromRGB(35,35,35)
    sidebarHeader.Parent = sidebarFrame

    local headerLabel = Instance.new("TextLabel")
    headerLabel.Size = UDim2.new(1, -60, 1, 0)
    headerLabel.Position = UDim2.new(0, 10, 0, 0)
    headerLabel.Text = "DEV TESTER MENU"
    headerLabel.TextColor3 = Color3.new(1,1,1)
    headerLabel.Font = Enum.Font.GothamBold
    headerLabel.TextSize = 14
    headerLabel.TextXAlignment = Enum.TextXAlignment.Left
    headerLabel.Parent = sidebarHeader

    local minimizeBtn = Instance.new("TextButton")
    minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
    minimizeBtn.Position = UDim2.new(1, -55, 0, 2.5)
    minimizeBtn.Text = "−"
    minimizeBtn.Font = Enum.Font.GothamBold
    minimizeBtn.TextSize = 18
    minimizeBtn.TextColor3 = Color3.new(1,1,1)
    minimizeBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    minimizeBtn.BorderSizePixel = 0
    minimizeBtn.Parent = sidebarHeader

    local sidebarCloseBtn = Instance.new("TextButton")
    sidebarCloseBtn.Size = UDim2.new(0, 25, 0, 25)
    sidebarCloseBtn.Position = UDim2.new(1, -28, 0, 2.5)
    sidebarCloseBtn.Text = "×"
    sidebarCloseBtn.Font = Enum.Font.GothamBold
    sidebarCloseBtn.TextSize = 16
    sidebarCloseBtn.TextColor3 = Color3.new(1,1,1)
    sidebarCloseBtn.BackgroundColor3 = Color3.fromRGB(160,50,50)
    sidebarCloseBtn.BorderSizePixel = 0
    sidebarCloseBtn.Parent = sidebarHeader

    do
        local dragging, dragStart, startPos
        sidebarHeader.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                dragStart = input.Position
                startPos = sidebarFrame.Position
            end
        end)
        sidebarHeader.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = false
            end
        end)
        game:GetService("UserInputService").InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local delta = input.Position - dragStart
                sidebarFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    tabContainer = Instance.new("Frame")
    tabContainer.Size = UDim2.new(1, 0, 0, 35)
    tabContainer.Position = UDim2.new(0, 0, 0, 30)
    tabContainer.BackgroundColor3 = Color3.fromRGB(30,30,30)
    tabContainer.Parent = sidebarFrame
    
    farmTab = Instance.new("TextButton")
    farmTab.Size = UDim2.new(0.5, -1, 1, 0)
    farmTab.Text = "Farm"
    farmTab.Font = Enum.Font.Gotham
    farmTab.BackgroundColor3 = Color3.fromRGB(45,45,45)
    farmTab.TextColor3 = Color3.new(1,1,1)
    -- **PERBAIKAN DI SINI**
    farmTab.Parent = tabContainer

    generalTab = Instance.new("TextButton")
    generalTab.Size = UDim2.new(0.5, -1, 1, 0)
    generalTab.Position = UDim2.new(0.5, 1, 0, 0)
    generalTab.Text = "General"
    generalTab.Font = Enum.Font.Gotham
    generalTab.BackgroundColor3 = Color3.fromRGB(30,30,30)
    generalTab.TextColor3 = Color3.new(1,1,1)
    generalTab.Parent = tabContainer

    local contentContainer = Instance.new("Frame")
    contentContainer.Size = UDim2.new(1, -10, 1, -70)
    contentContainer.Position = UDim2.new(0, 5, 0, 65)
    contentContainer.BackgroundTransparency = 1
    contentContainer.Parent = sidebarFrame
    
    farmContent = Instance.new("Frame")
    farmContent.Size = UDim2.new(1,0,1,0)
    farmContent.Parent = contentContainer

    generalContent = Instance.new("Frame")
    generalContent.Size = UDim2.new(1,0,1,0)
    generalContent.Visible = false
    generalContent.Parent = contentContainer
    
    local generalTitle = Instance.new("TextLabel")
    generalTitle.Size = UDim2.new(1, 0, 0, 20)
    generalTitle.Position = UDim2.new(0, 10, 0, 10)
    generalTitle.Text = "Debug Tools"
    generalTitle.Font = Enum.Font.GothamBold
    generalTitle.TextColor3 = Color3.new(1,1,1)
    generalTitle.BackgroundTransparency = 1
    generalTitle.Parent = generalContent

    local farmAllButton = Instance.new("TextButton")
    farmAllButton.Name = "InstantFarmButton"
    farmAllButton.Size = UDim2.new(1, -20, 0, 40)
    farmAllButton.Position = UDim2.new(0, 10, 0, 40)
    farmAllButton.Text = "Instant Farm All (DEV)"
    farmAllButton.Font = Enum.Font.GothamBold
    farmAllButton.TextSize = 14
    farmAllButton.TextColor3 = Color3.new(1,1,1)
    farmAllButton.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
    farmAllButton.Parent = generalContent
    farmAllButton.MouseButton1Click:Connect(function() instantFarmAll(farmAllButton) end)
    
    info = Instance.new("TextLabel")
    info.Size = UDim2.new(1, 0, 0, 20); info.Position = UDim2.new(0,0,0,0); info.Text = "Menunggu Ikan..."; info.Parent = farmContent
    distLabel = Instance.new("TextLabel")
    distLabel.Size = UDim2.new(1, 0, 0, 18); distLabel.Position = UDim2.new(0,0,0,22); distLabel.Text = "Jarak: -"; distLabel.Parent = farmContent
    anchorLabel = Instance.new("TextLabel")
    anchorLabel.Size = UDim2.new(1, 0, 0, 18); anchorLabel.Position = UDim2.new(0,0,0,42); anchorLabel.Text = "Spot Terdekat: -"; anchorLabel.Parent = farmContent

    local function createSidebarToggle(name, yPos, parent, defaultState, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 0, 30)
        frame.Position = UDim2.new(0, 0, 0, yPos)
        frame.BackgroundTransparency = 1
        frame.Parent = parent
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.7, -5, 1, 0); label.Text = name; label.Parent = frame
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(0.3, 0, 0, 24)
        button.Position = UDim2.new(0.7, 0, 0, 3)
        button.Parent = frame
        local function updateVisuals(state)
            button.Text = state and "ON" or "OFF"
            button.BackgroundColor3 = state and Color3.fromRGB(60,180,60) or Color3.fromRGB(180,60,60)
        end
        updateVisuals(defaultState)
        button.MouseButton1Click:Connect(function() callback(updateVisuals) end)
    end
    
    local filterHeader = Instance.new("TextLabel")
    filterHeader.Size = UDim2.new(1, 0, 0, 20)
    filterHeader.Position = UDim2.new(0, 10, 0, 75)
    filterHeader.Text = "Filter Target Kelangkaan"
    filterHeader.Font = Enum.Font.GothamBold
    filterHeader.TextColor3 = Color3.new(1,1,1)
    filterHeader.Parent = farmContent

    local raritiesToFilter = {"common", "uncommon", "rare", "epic", "legendary", "mythical"}
    local startY = 105
    for i, rarityName in ipairs(raritiesToFilter) do
        createSidebarToggle(rarityName:sub(1,1):upper()..rarityName:sub(2), startY + (i-1)*35, farmContent, rarityFilter[rarityName], function(updateVisuals)
            rarityFilter[rarityName] = not rarityFilter[rarityName]
            updateVisuals(rarityFilter[rarityName])
        end)
    end
    
    local controlsYStart = 320
    createSidebarToggle("Auto Focus", controlsYStart, farmContent, autoFocus, function(update) autoFocus = not autoFocus; update(autoFocus) end)
    createSidebarToggle("Auto Teleport", controlsYStart + 40, farmContent, autoTeleport, function(update) autoTeleport = not autoTeleport; update(autoTeleport) end)
    createSidebarToggle("Auto Fly", controlsYStart + 80, farmContent, autoFly, function(update) autoFly = not autoFly; update(autoFly); if not autoFly and flying then stopFlying() end end)
    
    local function switchTab(tabName)
        farmContent.Visible = (tabName == "farm")
        generalContent.Visible = (tabName == "general")
        farmTab.BackgroundColor3 = (tabName == "farm") and Color3.fromRGB(45,45,45) or Color3.fromRGB(30,30,30)
        generalTab.BackgroundColor3 = (tabName == "general") and Color3.fromRGB(45,45,45) or Color3.fromRGB(30,30,30)
    end
    farmTab.MouseButton1Click:Connect(function() switchTab("farm") end)
    generalTab.MouseButton1Click:Connect(function() switchTab("general") end)
    switchTab("farm")
    
    local isMinimized = false
    local originalSize = sidebarFrame.Size
    minimizeBtn.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        contentContainer.Visible = not isMinimized
        tabContainer.Visible = not isMinimized
        if isMinimized then
            minimizeBtn.Text = "+"
            sidebarFrame.Size = UDim2.new(0, 280, 0, 30)
        else
            minimizeBtn.Text = "−"
            sidebarFrame.Size = originalSize
        end
    end)
    sidebarCloseBtn.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)
end

-- Inisialisasi
pcall(buildUI)
print("Script Tester Game dimuat. Fungsionalitas UI telah diperbaiki.")
