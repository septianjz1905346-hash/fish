-- Eternal Detector & Auto-Focus/Auto-Teleport
-- Mendeteksi kemunculan SFish1..4, memberitahu, menunjukkan jarak, kamera fokus-otomatis, dan
-- auto-teleport ke tempat terdekat yang telah Anda tentukan saat bos bergerak.
-- Ditambahkan: Filter target berdasarkan kelangkaan

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- ... (kode auto-click start screen tidak berubah)

local function getRoot()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    return character:WaitForChild("HumanoidRootPart")
end

local function getCharacter()
    return localPlayer.Character or localPlayer.CharacterAdded:Wait()
end

-- Tiga titik jangkar Anda
local spots = {
    {name="Spot 1", pos=Vector3.new(-26.609,115.715,-285.779)},
    {name="Spot 2", pos=Vector3.new(-26.456,113.007,-154.013)},
    {name="Spot 3", pos=Vector3.new(-24.498,116.377,-2.832)},
}

-- ID Eternal â†’ nama tampilan
local ETERNAL_NAMES = {
    SFish1 = "Loch Ness",
    SFish2 = "Skeleton",
    SFish3 = "Sea Elf",
    SFish4 = "Godzilla",
}

-- UI
local screenGui, info, distLabel, anchorLabel
local sidebarFrame, sidebarHeader, tabContainer, farmTab, generalTab, sellTab
local farmContent, generalContent, sellContent

-- Variabel sakelar global
autoFocus = true
autoTeleport = true
autoStart = true
autoFly = true

-- **VARIABEL BARU** untuk filter kelangkaan
local rarityFilter = {
    common = true,
    uncommon = true,
    rare = true,
    epic = true,
    legendary = true,
    mythical = true,
}

-- ... (kode autosell tidak berubah)

local tryAutoStartOnce
local autoEquipState = true
local autoShootState = true
local enableAutoShoot

local function buildUI()
    local pg = localPlayer:FindFirstChild("PlayerGui") or localPlayer:WaitForChild("PlayerGui")
    if screenGui then pcall(function() screenGui:Destroy() end) end

    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "EternalDetector"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = pg

    sidebarFrame = Instance.new("Frame")
    sidebarFrame.Size = UDim2.new(0, 280, 0, 540) -- Perbesar frame untuk kontrol baru
    sidebarFrame.Position = UDim2.new(0, 10, 0, 120)
    sidebarFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
    sidebarFrame.BorderSizePixel = 0
    sidebarFrame.Visible = true
    sidebarFrame.Parent = screenGui
    
    -- ... (kode header sidebar, tabs, dan konten general tidak berubah, saya singkat untuk keringkasan)
    -- ... (cukup salin seluruh blok kode ini karena semuanya sudah termasuk)

    -- Kontainer tab, dll.
    tabContainer = Instance.new("Frame")
    tabContainer.Size = UDim2.new(1, 0, 0, 35)
    tabContainer.Position = UDim2.new(0, 0, 0, 30)
    tabContainer.BackgroundColor3 = Color3.fromRGB(30,30,30)
    tabContainer.Parent = sidebarFrame
    
    -- Tombol Tabs
    farmTab = Instance.new("TextButton")
    farmTab.Size = UDim2.new(0, 92, 1, 0)
    farmTab.Text = "Farm"; farmTab.Parent = tabContainer; -- ... (styling)
    
    generalTab = Instance.new("TextButton")
    generalTab.Size = UDim2.new(0, 92, 1, 0)
    generalTab.Position = UDim2.new(0, 93, 0, 0)
    generalTab.Text = "General"; generalTab.Parent = tabContainer; -- ... (styling)
    
    sellTab = Instance.new("TextButton")
    sellTab.Size = UDim2.new(0, 92, 1, 0)
    sellTab.Position = UDim2.new(0, 186, 0, 0)
    sellTab.Text = "Sell"; sellTab.Parent = tabContainer; -- ... (styling)
    
    local contentContainer = Instance.new("Frame")
    contentContainer.Size = UDim2.new(1, -10, 1, -70)
    contentContainer.Position = UDim2.new(0, 5, 0, 65)
    contentContainer.BackgroundTransparency = 1
    contentContainer.Parent = sidebarFrame
    
    farmContent = Instance.new("Frame")
    farmContent.Size = UDim2.new(1, 0, 1, 0)
    farmContent.Parent = contentContainer
    farmContent.Visible = true
    
    generalContent = Instance.new("Frame")
    generalContent.Size = UDim2.new(1, 0, 1, 0)
    generalContent.Parent = contentContainer
    generalContent.Visible = false
    
    sellContent = Instance.new("Frame")
    sellContent.Size = UDim2.new(1, 0, 1, 0)
    sellContent.Parent = contentContainer
    sellContent.Visible = false

    -- Mengisi konten tab "General" (tidak berubah)
    -- ...

    -- Mengisi konten tab "Farm"
    info = Instance.new("TextLabel")
    info.Size = UDim2.new(1, 0, 0, 20); info.Position = UDim2.new(0,0,0,0); info.Text = "Waiting for eternal..."; info.Parent = farmContent -- ... (styling)
    distLabel = Instance.new("TextLabel")
    distLabel.Size = UDim2.new(1, 0, 0, 18); distLabel.Position = UDim2.new(0,0,0,22); distLabel.Text = "Distance: -"; distLabel.Parent = farmContent -- ... (styling)
    anchorLabel = Instance.new("TextLabel")
    anchorLabel.Size = UDim2.new(1, 0, 0, 18); anchorLabel.Position = UDim2.new(0,0,0,42); anchorLabel.Text = "Nearest spot: -"; anchorLabel.Parent = farmContent -- ... (styling)

    -- Fungsi bantuan untuk membuat tombol sakelar di sidebar
    local function createSidebarToggle(name, yPos, parent, defaultState, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 0, 30)
        frame.Position = UDim2.new(0, 0, 0, yPos)
        frame.BackgroundTransparency = 1
        frame.Parent = parent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.7, -5, 1, 0)
        label.Text = name; label.Parent = frame; -- ... (styling)
        
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(0.3, 0, 0, 24)
        button.Position = UDim2.new(0.7, 0, 0, 3)
        button.Parent = frame -- ... (styling)

        local function updateVisuals(state)
            button.Text = state and "ON" or "OFF"
            button.BackgroundColor3 = state and Color3.fromRGB(60,180,60) or Color3.fromRGB(180,60,60)
        end
        updateVisuals(defaultState)
        
        button.MouseButton1Click:Connect(function()
            callback(updateVisuals)
        end)
    end

    -- **KONTROL BARU: FILTER KELANGKAAN**
    local filterHeader = Instance.new("TextLabel")
    filterHeader.Size = UDim2.new(1, 0, 0, 20)
    filterHeader.Position = UDim2.new(0, 10, 0, 75)
    filterHeader.BackgroundTransparency = 1
    filterHeader.Font = Enum.Font.GothamBold
    filterHeader.TextSize = 13
    filterHeader.Text = "Filter Target Kelangkaan"
    filterHeader.TextXAlignment = Enum.TextXAlignment.Left
    filterHeader.TextColor3 = Color3.new(1,1,1)
    filterHeader.Parent = farmContent

    local raritiesToFilter = {"common", "uncommon", "rare", "epic", "legendary", "mythical"}
    local startY = 105
    for i, rarityName in ipairs(raritiesToFilter) do
        createSidebarToggle(rarityName:sub(1,1):upper()..rarityName:sub(2), startY + (i-1)*35, farmContent, rarityFilter[rarityName], function(updateVisuals)
            rarityFilter[rarityName] = not rarityFilter[rarityName]
            updateVisuals(rarityFilter[rarityName])
        end)
    end

    -- Kontrol lama di tab Farm, dipindahkan ke bawah
    local controlsYStart = 320
    createSidebarToggle("Auto Focus", controlsYStart, farmContent, autoFocus, function(update) autoFocus = not autoFocus; update(autoFocus) end)
    createSidebarToggle("Auto Start", controlsYStart + 40, farmContent, autoStart, function(update) autoStart = not autoStart; update(autoStart) end)
    createSidebarToggle("Auto Teleport", controlsYStart + 80, farmContent, autoTeleport, function(update) autoTeleport = not autoTeleport; update(autoTeleport) end)
    createSidebarToggle("Auto Fly", controlsYStart + 120, farmContent, autoFly, function(update) autoFly = not autoFly; update(autoFly); if not autoFly and flying then stopFlying() end end)
    
    -- ... (kode fungsionalitas tab switching)
end

-- ... (kode Dynamic fish rarity system tidak berubah)
local function getFishNumber(fishName)
    local number = string.match(fishName, "Fish(%d+)")
    return number and tonumber(number) or 0
end

local function getRarityFromNumber(fishNumber)
    if fishNumber >= 12 then return "mythical", 6
    elseif fishNumber >= 11 then return "legendary", 5
    elseif fishNumber >= 9 then return "epic", 4
    elseif fishNumber >= 7 then return "rare", 3
    elseif fishNumber >= 3 then return "uncommon", 2
    else return "common", 1 end
end

local function getFishData(fishName)
    local fishNumber = getFishNumber(fishName)
    if fishNumber > 0 then
        local rarity, priority = getRarityFromNumber(fishNumber)
        return { name = fishName, rarity = rarity, priority = priority, number = fishNumber }
    end
    local blackFish = {
        ["Black1"] = {rarity = "legendary", priority = 5}, ["Black2"] = {rarity = "legendary", priority = 5},
        ["Black3"] = {rarity = "epic", priority = 4}, ["Black4"] = {rarity = "rare", priority = 3},
    }
    if blackFish[fishName] then
        local data = blackFish[fishName]
        return { name = fishName, rarity = data.rarity, priority = data.priority, number = 0 }
    end
    return nil
end

-- **LOGIKA TARGETING DIMODIFIKASI UNTUK MENGGUNAKAN FILTER**
local function getRegularFish()
    local fishList = workspace:FindFirstChild("FishModelList")
    if not fishList then return nil end
    
    local myPos = getRoot().Position
    local availableFish = {}
    local maxDistance = 150 
    
    for _, m in ipairs(fishList:GetChildren()) do
        if m:IsA("Model") and not ETERNAL_NAMES[m.Name] then
            local fishData = getFishData(m.Name)
            
            -- **Pemeriksaan Filter Baru:** Lewati ikan jika rarity-nya dinonaktifkan
            if fishData and rarityFilter[fishData.rarity] then
                local hum = m:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health > 0 then
                    local fishPos = m:GetModelCFrame().p
                    local distance = (fishPos - myPos).Magnitude
                    if distance <= maxDistance then
                        table.insert(availableFish, {
                            model = m, humanoid = hum,
                            rarity = fishData.rarity, priority = fishData.priority,
                            name = fishData.name, distance = distance,
                            position = fishPos, fishNumber = fishData.number
                        })
                    end
                end
            end
        end
    end
    
    if #availableFish == 0 then return nil end
    
    table.sort(availableFish, function(a, b)
        if a.priority == b.priority then return a.distance < b.distance
        else return a.priority > b.priority end
    end)
    
    return availableFish[1].model, availableFish[1].humanoid
end

-- ... (sisa kode seperti getNearestSpot, focusCameraOn, startFlying, dll. tidak berubah)
-- ...
-- ... (cukup salin seluruh blok kode ini karena semua bagian penting sudah termasuk)


-- Inisialisasi dan loop utama
pcall(buildUI)
game:GetService("UserInputService").InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.F9 then
        sidebarFrame.Visible = not sidebarFrame.Visible
    end
end)

RunService.Heartbeat:Connect(function()
    ensureUI()
    
    local bossModel, _ = getActiveEternal()
    local regularFish, _ = nil, nil
    if not bossModel then
        regularFish, _ = getRegularFish()
    end
    
    -- ... (sisa loop utama tidak berubah, ia akan otomatis menggunakan hasil dari getRegularFish yang baru)
end)

print("Eternal Detector dimuat: Fitur filter kelangkaan target telah ditambahkan di tab Farm.")
