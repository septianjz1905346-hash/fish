-- Script Tester Game Final (Dibangun Ulang)
-- Menggabungkan semua fitur dengan fokus pada stabilitas UI
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- ===================================================================
-- PENGATURAN & VARIABEL GLOBAL
-- ===================================================================
local autoFocus = true
local autoTeleport = true
local autoFly = true
local flying = false
local currentSpotIndex = nil
local lastTpTime = 0
local TP_COOLDOWN = 1.8

local rarityFilter = {
    common = true, uncommon = true, rare = true,
    epic = true, legendary = true, mythical = true,
}

local screenGui -- Referensi utama untuk UI

-- ===================================================================
-- FUNGSI-FUNGSI FITUR DEVELOPER
-- ===================================================================

local function instantFarmAll(button)
    pcall(function()
        button.Text = "MEMPROSES..."
        button.BackgroundColor3 = Color3.fromRGB(255, 165, 0) -- Oranye

        local fishList = workspace:FindFirstChild("FishModelList")
        if not fishList then return end

        local allFishModels = {}
        for _, m in ipairs(fishList:GetChildren()) do
            if m:IsA("Model") then
                local hum = m:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health > 0 then
                    table.insert(allFishModels, m)
                    hum.Health = 1
                end
            end
        end
        task.wait(0.1)

        local screenSize = workspace.CurrentCamera.ViewportSize
        local centerX = screenSize.X / 2
        local centerY = screenSize.Y / 2
        local originalCFrame = camera.CFrame

        for _, fishModel in ipairs(allFishModels) do
            if fishModel and fishModel.PrimaryPart and fishModel.PrimaryPart:IsDescendantOf(workspace) then
                local targetPos = fishModel.PrimaryPart.Position
                camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetPos)
                task.wait()
                VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
                VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)
                task.wait(0.05)
            end
        end

        camera.CFrame = originalCFrame
        button.Text = "Instant Farm All (DEV)"
        button.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
    end)
end

local function teleportFishToPlayer(fishName)
    if not fishName or fishName == "" then return end
    local fishList = workspace:FindFirstChild("FishModelList")
    local playerRoot = localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not (fishList and playerRoot) then return end
    local targetFish = fishList:FindFirstChild(fishName)
    if targetFish and targetFish:IsA("Model") and targetFish.PrimaryPart then
        targetFish:SetPrimaryPartCFrame(playerRoot.CFrame * CFrame.new(0, 0, -10))
        print("Ikan '" .. fishName .. "' telah dipanggil.")
    else
        print("Ikan dengan nama '" .. fishName .. "' tidak ditemukan.")
    end
end

local function printAllFishInfo()
    print("===== INFO SEMUA IKAN AKTIF =====")
    local fishList = workspace:FindFirstChild("FishModelList")
    if not fishList then print("Folder 'FishModelList' tidak ditemukan.") return end
    local count = 0
    for _, m in ipairs(fishList:GetChildren()) do
        if m:IsA("Model") then
            local hum = m:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                count = count + 1
                local pos = m.PrimaryPart.Position
                print(string.format("- Nama: %s | HP: %.1f/%.1f | Posisi: (%.1f, %.1f, %.1f)", m.Name, hum.Health, hum.MaxHealth, pos.X, pos.Y, pos.Z))
            end
        end
    end
    print("===================================")
    print("Total ikan aktif ditemukan: " .. count)
end

-- ===================================================================
-- FUNGSI PEMBUATAN UI (DIBANGUN ULANG TOTAL)
-- ===================================================================

local function buildUI()
    local pg = localPlayer:FindFirstChild("PlayerGui") or localPlayer:WaitForChild("PlayerGui")
    if screenGui then pcall(function() screenGui:Destroy() end) end

    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FishFarmUI_Stable"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = pg

    local sidebarFrame = Instance.new("Frame")
    sidebarFrame.Size = UDim2.new(0, 280, 0, 580)
    sidebarFrame.Position = UDim2.new(0, 10, 0, 120)
    sidebarFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
    sidebarFrame.BorderSizePixel = 0
    sidebarFrame.Parent = screenGui
    
    local sidebarHeader = Instance.new("Frame")
    sidebarHeader.Size = UDim2.new(1, 0, 0, 30)
    sidebarHeader.Position = UDim2.new(0, 0, 0, 0)
    sidebarHeader.BackgroundColor3 = Color3.fromRGB(35,35,35)
    sidebarHeader.BorderSizePixel = 0
    sidebarHeader.Parent = sidebarFrame

    local headerLabel = Instance.new("TextLabel")
    headerLabel.Size = UDim2.new(1, -60, 1, 0)
    headerLabel.Position = UDim2.new(0, 10, 0, 0)
    headerLabel.BackgroundTransparency = 1
    headerLabel.Font = Enum.Font.GothamBold
    headerLabel.TextSize = 14
    headerLabel.Text = "DEV TESTER MENU"
    headerLabel.TextXAlignment = Enum.TextXAlignment.Left
    headerLabel.TextColor3 = Color3.new(1,1,1)
    headerLabel.Parent = sidebarHeader

    local minimizeBtn = Instance.new("TextButton")
    minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
    minimizeBtn.Position = UDim2.new(1, -55, 0, 2.5)
    minimizeBtn.Text = "−"
    minimizeBtn.Font = Enum.Font.GothamBold
    minimizeBtn.TextSize = 18
    minimizeBtn.TextColor3 = Color3.new(1,1,1)
    minimizeBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    minimizeBtn.BorderSizePixel = 0
    minimizeBtn.Parent = sidebarHeader

    local sidebarCloseBtn = Instance.new("TextButton")
    sidebarCloseBtn.Size = UDim2.new(0, 25, 0, 25)
    sidebarCloseBtn.Position = UDim2.new(1, -28, 0, 2.5)
    sidebarCloseBtn.Text = "×"
    sidebarCloseBtn.Font = Enum.Font.GothamBold
    sidebarCloseBtn.TextSize = 16
    sidebarCloseBtn.TextColor3 = Color3.new(1,1,1)
    sidebarCloseBtn.BackgroundColor3 = Color3.fromRGB(160,50,50)
    sidebarCloseBtn.BorderSizePixel = 0
    sidebarCloseBtn.Parent = sidebarHeader

    do -- Draggable logic
        local dragging, dragStart, startPos
        sidebarHeader.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = true; dragStart = input.Position; startPos = sidebarFrame.Position end end)
        sidebarHeader.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end end)
        game:GetService("UserInputService").InputChanged:Connect(function(input) if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then local delta = input.Position - dragStart; sidebarFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y) end end)
    end

    local tabContainer = Instance.new("Frame")
    tabContainer.Size = UDim2.new(1, 0, 0, 35)
    tabContainer.Position = UDim2.new(0, 0, 0, 30)
    tabContainer.BackgroundColor3 = Color3.fromRGB(30,30,30)
    tabContainer.BorderSizePixel = 0
    tabContainer.Parent = sidebarFrame
    
    local farmTab = Instance.new("TextButton")
    farmTab.Size = UDim2.new(0.5, 0, 1, 0)
    farmTab.Position = UDim2.new(0, 0, 0, 0)
    farmTab.Font = Enum.Font.Gotham
    farmTab.TextSize = 12
    farmTab.Text = "Farm"
    farmTab.BackgroundColor3 = Color3.fromRGB(45,45,45)
    farmTab.TextColor3 = Color3.new(1,1,1)
    farmTab.BorderSizePixel = 0
    farmTab.Parent = tabContainer

    local generalTab = Instance.new("TextButton")
    generalTab.Size = UDim2.new(0.5, 0, 1, 0)
    generalTab.Position = UDim2.new(0.5, 0, 0, 0)
    generalTab.Font = Enum.Font.Gotham
    generalTab.TextSize = 12
    generalTab.Text = "General"
    generalTab.BackgroundColor3 = Color3.fromRGB(30,30,30)
    generalTab.TextColor3 = Color3.fromRGB(180,180,180)
    generalTab.BorderSizePixel = 0
    generalTab.Parent = tabContainer

    local contentContainer = Instance.new("Frame")
    contentContainer.Size = UDim2.new(1, -10, 1, -70)
    contentContainer.Position = UDim2.new(0, 5, 0, 65)
    contentContainer.BackgroundTransparency = 1
    contentContainer.Parent = sidebarFrame
    
    local farmContent = Instance.new("Frame")
    farmContent.Size = UDim2.new(1,0,1,0)
    farmContent.BackgroundTransparency = 1
    farmContent.Parent = contentContainer

    local generalContent = Instance.new("Frame")
    generalContent.Size = UDim2.new(1,0,1,0)
    generalContent.BackgroundTransparency = 1
    generalContent.Visible = false
    generalContent.Parent = contentContainer
    
    local genScroll = Instance.new("ScrollingFrame")
    genScroll.Size = UDim2.new(1, 0, 1, 0); genScroll.CanvasSize = UDim2.new(0, 0, 0, 450); genScroll.BackgroundTransparency = 1; genScroll.BorderSizePixel = 0; genScroll.ScrollBarThickness = 6; genScroll.Parent = generalContent

    local function createDevSection(title, yPos)
        local header = Instance.new("TextLabel"); header.Size = UDim2.new(1, -20, 0, 20); header.Position = UDim2.new(0, 10, 0, yPos); header.Text = title; header.Font = Enum.Font.GothamBold; header.TextXAlignment = Enum.TextXAlignment.Left; header.TextColor3 = Color3.new(1,1,1); header.BackgroundTransparency = 1; header.Parent = genScroll
        return yPos + 25
    end

    local function createDevSlider(label, yPos, min, max, default, callback)
        local sliderLabel = Instance.new("TextLabel"); sliderLabel.Size = UDim2.new(1, -20, 0, 20); sliderLabel.Position = UDim2.new(0, 10, 0, yPos); sliderLabel.Text = label .. ": " .. default; sliderLabel.TextXAlignment = Enum.TextXAlignment.Left; sliderLabel.TextColor3 = Color3.new(0.9,0.9,0.9); sliderLabel.BackgroundTransparency = 1; sliderLabel.Font = Enum.Font.Gotham; sliderLabel.Parent = genScroll
        local slider = Instance.new("Slider"); slider.Size = UDim2.new(1, -20, 0, 20); slider.Position = UDim2.new(0, 10, 0, yPos + 20); slider.MinValue = min; slider.MaxValue = max; slider.Value = default; slider.Parent = genScroll
        slider.ValueChanged:Connect(function(value)
            local roundedValue = math.floor(value + 0.5); sliderLabel.Text = label .. ": " .. roundedValue; callback(roundedValue)
        end)
        return yPos + 55
    end

    local currentY = 10
    currentY = createDevSection("Player Control", currentY)
    currentY = createDevSlider("WalkSpeed", currentY, 16, 200, 16, function(v) local char = localPlayer.Character; if char and char:FindFirstChild("Humanoid") then char.Humanoid.WalkSpeed = v end end)
    currentY = createDevSlider("JumpPower", currentY, 50, 300, 50, function(v) local char = localPlayer.Character; if char and char:FindFirstChild("Humanoid") then char.Humanoid.JumpPower = v end end)

    currentY = createDevSection("Instant Actions", currentY + 10)
    local farmAllButton = Instance.new("TextButton"); farmAllButton.Size = UDim2.new(1, -20, 0, 40); farmAllButton.Position = UDim2.new(0, 10, 0, currentY); farmAllButton.Text = "Instant Farm All (DEV)"; farmAllButton.BackgroundColor3 = Color3.fromRGB(220, 20, 60); farmAllButton.Font = Enum.Font.GothamBold; farmAllButton.TextColor3=Color3.new(1,1,1); farmAllButton.Parent = genScroll
    farmAllButton.MouseButton1Click:Connect(function() instantFarmAll(farmAllButton) end)
    currentY = currentY + 50
    
    currentY = createDevSection("Summoning", currentY)
    local fishNameInput = Instance.new("TextBox"); fishNameInput.Size = UDim2.new(0.6, -15, 0, 30); fishNameInput.Position = UDim2.new(0, 10, 0, currentY); fishNameInput.PlaceholderText = "Nama Ikan..."; fishNameInput.ClearTextOnFocus = false; fishNameInput.Font = Enum.Font.Gotham; fishNameInput.Parent = genScroll
    local summonBtn = Instance.new("TextButton"); summonBtn.Size = UDim2.new(0.4, -15, 0, 30); summonBtn.Position = UDim2.new(0.6, 0, 0, currentY); summonBtn.Text = "Panggil"; summonBtn.Font = Enum.Font.Gotham; summonBtn.Parent = genScroll
    summonBtn.MouseButton1Click:Connect(function() teleportFishToPlayer(fishNameInput.Text) end)
    currentY = currentY + 40

    currentY = createDevSection("Information", currentY)
    local printInfoBtn = Instance.new("TextButton"); printInfoBtn.Size = UDim2.new(1, -20, 0, 30); printInfoBtn.Position = UDim2.new(0, 10, 0, currentY); printInfoBtn.Text = "Print Info Semua Ikan ke Konsol"; printInfoBtn.Font = Enum.Font.Gotham; printInfoBtn.Parent = genScroll
    printInfoBtn.MouseButton1Click:Connect(printAllFishInfo)
    
    info = Instance.new("TextLabel"); info.Size = UDim2.new(1, 0, 0, 20); info.Position = UDim2.new(0, 0, 0, 0); info.Font = Enum.Font.Gotham; info.Text = "Menunggu Ikan..."; info.BackgroundTransparency=1; info.TextXAlignment = Enum.TextXAlignment.Left; info.TextColor3 = Color3.fromRGB(200,200,200); info.Parent = farmContent
    distLabel = Instance.new("TextLabel"); distLabel.Size = UDim2.new(1, 0, 0, 18); distLabel.Position = UDim2.new(0, 0, 0, 22); distLabel.Font = Enum.Font.Gotham; distLabel.Text = "Jarak: -"; distLabel.BackgroundTransparency=1; distLabel.TextXAlignment = Enum.TextXAlignment.Left; distLabel.TextColor3 = Color3.fromRGB(180,220,180); distLabel.Parent = farmContent
    anchorLabel = Instance.new("TextLabel"); anchorLabel.Size = UDim2.new(1, 0, 0, 18); anchorLabel.Position = UDim2.new(0, 0, 0, 42); anchorLabel.Font = Enum.Font.Gotham; anchorLabel.Text = "Spot Terdekat: -"; anchorLabel.BackgroundTransparency=1; anchorLabel.TextXAlignment = Enum.TextXAlignment.Left; anchorLabel.TextColor3 = Color3.fromRGB(180,180,230); anchorLabel.Parent = farmContent

    local function createSidebarToggle(name, yPos, parent, defaultState, callback)
        local frame = Instance.new("Frame"); frame.Size = UDim2.new(1, 0, 0, 30); frame.Position = UDim2.new(0, 0, 0, yPos); frame.BackgroundTransparency = 1; frame.Parent = parent
        local label = Instance.new("TextLabel"); label.Size = UDim2.new(0.7, -5, 1, 0); label.Text = name; label.TextXAlignment = Enum.TextXAlignment.Left; label.TextColor3 = Color3.new(1,1,1); label.Font = Enum.Font.Gotham; label.Parent = frame
        local button = Instance.new("TextButton"); button.Size = UDim2.new(0.3, 0, 0, 24); button.Position = UDim2.new(0.7, 0, 0, 3); button.Font = Enum.Font.GothamBold; button.TextColor3 = Color3.new(1,1,1); button.Parent = frame
        local function updateVisuals(state)
            button.Text = state and "ON" or "OFF"; button.BackgroundColor3 = state and Color3.fromRGB(60,180,60) or Color3.fromRGB(180,60,60)
        end
        updateVisuals(defaultState); button.MouseButton1Click:Connect(function() callback(updateVisuals) end)
    end
    
    local filterHeader = Instance.new("TextLabel"); filterHeader.Size = UDim2.new(1, 0, 0, 20); filterHeader.Position = UDim2.new(0, 10, 0, 75); filterHeader.Text = "Filter Target Kelangkaan"; filterHeader.Font = Enum.Font.GothamBold; filterHeader.TextColor3 = Color3.new(1,1,1); filterHeader.BackgroundTransparency=1; filterHeader.Parent = farmContent
    local raritiesToFilter = {"common", "uncommon", "rare", "epic", "legendary", "mythical"}
    local startY = 105
    for i, rarityName in ipairs(raritiesToFilter) do
        createSidebarToggle(rarityName:sub(1,1):upper()..rarityName:sub(2), startY + (i-1)*35, farmContent, rarityFilter[rarityName], function(updateVisuals)
            rarityFilter[rarityName] = not rarityFilter[rarityName]; updateVisuals(rarityFilter[rarityName])
        end)
    end
    
    local controlsYStart = 320
    createSidebarToggle("Auto Focus", controlsYStart, farmContent, autoFocus, function(update) autoFocus = not autoFocus; update(autoFocus) end)
    createSidebarToggle("Auto Teleport", controlsYStart + 40, farmContent, autoTeleport, function(update) autoTeleport = not autoTeleport; update(autoTeleport) end)
    createSidebarToggle("Auto Fly", controlsYStart + 80, farmContent, autoFly, function(update) autoFly = not autoFly; update(autoFly); if not autoFly and flying then stopFlying() end end)
    
    local function switchTab(tabName)
        farmContent.Visible = (tabName == "farm"); generalContent.Visible = (tabName == "general")
        farmTab.BackgroundColor3 = (tabName == "farm") and Color3.fromRGB(45,45,45) or Color3.fromRGB(30,30,30)
        generalTab.BackgroundColor3 = (tabName == "general") and Color3.fromRGB(45,45,45) or Color3.fromRGB(30,30,30)
    end
    farmTab.MouseButton1Click:Connect(function() switchTab("farm") end); generalTab.MouseButton1Click:Connect(function() switchTab("general") end); switchTab("farm")
    
    local isMinimized = false; local originalSize = sidebarFrame.Size
    minimizeBtn.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized; contentContainer.Visible = not isMinimized; tabContainer.Visible = not isMinimized
        if isMinimized then minimizeBtn.Text = "+"; sidebarFrame.Size = UDim2.new(0, 280, 0, 30)
        else minimizeBtn.Text = "−"; sidebarFrame.Size = originalSize end
    end)
    sidebarCloseBtn.MouseButton1Click:Connect(function() screenGui:Destroy() end)
end

local spots = {
    {name="Spot 1", pos=Vector3.new(-26.609,115.715,-285.779)},
    {name="Spot 2", pos=Vector3.new(-26.456,113.007,-154.013)},
    {name="Spot 3", pos=Vector3.new(-24.498,116.377,-2.832)},
}

local ETERNAL_NAMES = {
    SFish1 = "Loch Ness", SFish2 = "Skeleton", SFish3 = "Sea Elf", SFish4 = "Godzilla",
}

local function getActiveEternal() local fishList = workspace:FindFirstChild("FishModelList"); if not fishList then return nil end; for _, m in ipairs(fishList:GetChildren()) do if m:IsA("Model") and ETERNAL_NAMES[m.Name] then local hum = m:FindFirstChildOfClass("Humanoid"); if hum and hum.Health > 0 then return m, hum end end end; return nil end
local function getFishData(fishName) local fishNumber = tonumber(string.match(fishName, "Fish(%d+)")) or 0; if fishNumber > 0 then if fishNumber >= 12 then return {rarity="mythical", priority=6} elseif fishNumber >= 11 then return {rarity="legendary", priority=5} elseif fishNumber >= 9 then return {rarity="epic", priority=4} elseif fishNumber >= 7 then return {rarity="rare", priority=3} elseif fishNumber >= 3 then return {rarity="uncommon", priority=2} else return {rarity="common", priority=1} end end; return nil end
local function getRegularFish() local fishList = workspace:FindFirstChild("FishModelList"); if not fishList then return nil end; local myPos = getRoot().Position; local availableFish = {}; for _, m in ipairs(fishList:GetChildren()) do if m:IsA("Model") and not ETERNAL_NAMES[m.Name] then local fishData = getFishData(m.Name); if fishData and rarityFilter[fishData.rarity] then local hum = m:FindFirstChildOfClass("Humanoid"); if hum and hum.Health > 0 then local dist = (m:GetModelCFrame().p - myPos).Magnitude; if dist < 200 then table.insert(availableFish, {model=m, humanoid=hum, priority=fishData.priority, distance=dist}) end end end end end; if #availableFish == 0 then return nil end; table.sort(availableFish, function(a, b) if a.priority == b.priority then return a.distance < b.distance else return a.priority > b.priority end end); return availableFish[1].model, availableFish[1].humanoid end
local function startFlying() if flying then return end; flying = true; local root = getRoot(); local bodyVel = Instance.new("BodyVelocity", root); bodyVel.MaxForce = Vector3.new(math.huge, math.huge, math.huge); bodyVel.Velocity = Vector3.new(0, 0, 0); local bodyGyro = Instance.new("BodyGyro", root); bodyGyro.MaxTorque = Vector3.new(0, math.huge, 0) end
local function stopFlying() if not flying then return end; flying = false; local root = getRoot(); if root then for _,v in ipairs(root:GetChildren()) do if v:IsA("BodyMover") then v:Destroy() end end end end
local function focusCameraOn(position) if not autoFocus then return end; camera.CameraType = Enum.CameraType.Scriptable; camera.CFrame = CFrame.lookAt(camera.CFrame.Position, position) end
local function releaseCamera() camera.CameraType = Enum.CameraType.Custom end
local function teleportToSpot(index) if not autoTeleport or (tick() - lastTpTime < TP_COOLDOWN) then return end; local sp = spots[index]; if not sp then return end; getRoot().CFrame = CFrame.new(sp.pos); currentSpotIndex = index; lastTpTime = tick(); if autoFly then startFlying() end end
local function getNearestSpot(toPos) local bestIndex, bestDist = 1, math.huge; for i, sp in ipairs(spots) do local d = (sp.pos - toPos).Magnitude; if d < bestDist then bestDist = d; bestIndex = i end end; return bestIndex end

-- Inisialisasi dan Loop Utama
pcall(buildUI)
print("Script Final Telah Dimuat. UI direkonstruksi untuk stabilitas.")

RunService.Heartbeat:Connect(function()
    if not (screenGui and screenGui.Parent) then return end
    local targetModel
    targetModel, _ = getActiveEternal()
    if not targetModel then
        targetModel, _ = getRegularFish()
    end
    if targetModel and targetModel.PrimaryPart then
        local targetPos = targetModel.PrimaryPart.Position
        local infoLabel = screenGui:FindFirstChild("sidebarFrame", true):FindFirstChild("info", true)
        if infoLabel then infoLabel.Text = targetModel.Name end
        focusCameraOn(targetPos)
        local nearestIndex = getNearestSpot(targetPos)
        if currentSpotIndex ~= nearestIndex then
            teleportToSpot(nearestIndex)
        end
    else
        releaseCamera()
        local infoLabel = screenGui:FindFirstChild("sidebarFrame", true):FindFirstChild("info", true)
        if infoLabel then infoLabel.Text = "Mencari ikan..." end
    end
end)
